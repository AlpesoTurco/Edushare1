<%- include ('Plantilla/Inicio') %>
  <!-- Encabezado -->
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-xl md:text-2xl font-semibold text-gray-900">Configuración del Torniquete</h1>
      <p class="text-sm text-gray-500">Administra puertas, reglas, horarios, políticas y credenciales.</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnSync" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Sincronizar</button>
      <button id="btnGuardar" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">Guardar cambios</button>
    </div>
  </header>

  <!-- Selección de puerta -->
  <section class="bg-white rounded-2xl border border-gray-200 p-4">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Puerta / Torniquete</h2>
    <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
      <label class="md:col-span-4">
        <span class="text-sm text-gray-700">Puerta</span>
        <select id="doorSelect" class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
          <!-- Llenar con GET /api/v1/developer/doors -->
          <option value="door-id-demo">Torniquete 1 (DEMO)</option>
        </select>
      </label>
      <div class="md:col-span-8 grid grid-cols-2 md:grid-cols-4 gap-2 items-end">
        <button id="btnUnlock" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">Desbloquear ahora</button>
        <button id="btnRuleLock" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Mantener bloqueado</button>
        <button id="btnRuleUnlock" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Mantener desbloqueado</button>
        <button id="btnRuleCustom" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Desbloqueo temporal…</button>
      </div>
    </div>

    <!-- Estado actual -->
    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="bg-gray-50 border border-gray-100 rounded-xl p-3">
        <div class="text-xs text-gray-500">Relé</div>
        <div id="relayStatus" class="text-sm font-medium text-gray-900">—</div>
      </div>
      <div class="bg-gray-50 border border-gray-100 rounded-xl p-3">
        <div class="text-xs text-gray-500">Posición de puerta</div>
        <div id="dps" class="text-sm font-medium text-gray-900">—</div>
      </div>
      <div class="bg-gray-50 border border-gray-100 rounded-xl p-3">
        <div class="text-xs text-gray-500">Regla de bloqueo</div>
        <div id="lockRule" class="text-sm font-medium text-gray-900">—</div>
      </div>
      <div class="bg-gray-50 border border-gray-100 rounded-xl p-3">
        <div class="text-xs text-gray-500">Termina</div>
        <div id="lockEnds" class="text-sm font-medium text-gray-900">—</div>
      </div>
    </div>

    <!-- Emergencia -->
    <div class="mt-4 border-t border-gray-100 pt-4">
      <h3 class="text-sm font-semibold text-gray-900 mb-2">Emergencia (todas las puertas)</h3>
      <div class="flex flex-wrap gap-2">
        <button id="btnLockdown" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Lockdown</button>
        <button id="btnEvac" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Evacuación</button>
        <button id="btnEmergReset" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Restaurar</button>
        <span id="emergStatus" class="text-sm text-gray-500 ml-auto">Estado: —</span>
      </div>
    </div>
  </section>

  <!-- Horarios y Festivos -->
<section class="bg-white rounded-2xl border border-gray-200 p-4">
  <h2 class="text-lg font-semibold text-gray-900 mb-3">Horarios & Festivos</h2>

  <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
    <label class="md:col-span-4">
      <span class="text-sm text-gray-700">Horario (Schedule)</span>
      <select id="scheduleSelect" class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
        <option value="">(Selecciona un horario)</option>
        <% (horarios || []).forEach(h => { %>
          <option value="<%= h.id_horario %>">
            <%= h.nombre_horario %> <%= h.activo ? '' : ' (inactivo)' %>
          </option>
        <% }) %>
      </select>
    </label>

    <label class="md:col-span-4">
      <span class="text-sm text-gray-700">Grupo de festivos</span>
      <select id="holidaySelect" class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
        <option value="">(Ninguno / “No Holidays”)</option>
        <!-- Llénalo luego si manejas grupos -->
      </select>
    </label>

    <div class="md:col-span-4 flex items-end gap-2">
      <button id="btnNewSchedule" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Nuevo horario</button>
      <button id="btnDelSchedule" class="px-3 py-2 rounded-lg border border-red-200 bg-white text-sm text-red-700 hover:bg-red-50" disabled>Eliminar</button>
    </div>
  </div>

  <!-- Vista previa del horario seleccionado -->
  <div id="schedulePreview" class="mt-4 hidden">
    <div class="bg-gray-50 border border-gray-100 rounded-xl p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm font-medium text-gray-900">
          <span id="previewName">—</span>
          <span id="previewBadge" class="ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium border"></span>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-xs">
        <% const diasEti = {lun:'Lunes', mar:'Martes', mie:'Miércoles', jue:'Jueves', vie:'Viernes', sab:'Sábado', dom:'Domingo'}; %>
        <% (horarios || []).forEach(() => {}); %> <!-- no hace nada, sólo para que EJS no queje en algunos motores -->
        <!-- El contenido real se llena por JS para el horario elegido -->
        <div id="previewBody" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
      </div>
    </div>
  </div>

  <!-- Editor simple de franjas -->
  <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
    <div class="bg-gray-50 border border-gray-100 rounded-xl p-3">
      <div class="text-sm font-medium text-gray-900 mb-2">Semana</div>
      <div class="grid grid-cols-2 gap-2 text-xs">
        <label class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-2">
          <span>Lunes</span>
          <input id="mon" type="text" placeholder="09:00-18:00" class="w-36 text-right focus:outline-none">
        </label>
        <label class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-2">
          <span>Martes</span>
          <input id="tue" type="text" placeholder="09:00-18:00" class="w-36 text-right focus:outline-none">
        </label>
        <label class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-2">
          <span>Miércoles</span>
          <input id="wed" type="text" placeholder="09:00-18:00" class="w-36 text-right focus:outline-none">
        </label>
        <label class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-2">
          <span>Jueves</span>
          <input id="thu" type="text" placeholder="—" class="w-36 text-right focus:outline-none">
        </label>
        <label class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-2">
          <span>Viernes</span>
          <input id="fri" type="text" placeholder="09:00-17:00" class="w-36 text-right focus:outline-none">
        </label>
        <label class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-2">
          <span>Sábado</span>
          <input id="sat" type="text" placeholder="—" class="w-36 text-right focus:outline-none">
        </label>
        <label class="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-2">
          <span>Domingo</span>
          <input id="sun" type="text" placeholder="—" class="w-36 text-right focus:outline-none">
        </label>
      </div>
    </div>

    <div class="bg-gray-50 border border-gray-100 rounded-xl p-3">
      <div class="text-sm font-medium text-gray-900 mb-2">Festivos</div>
      <div class="flex items-center gap-2">
        <input id="hol1" type="text" placeholder="10:00-14:00; 16:00-18:00" class="flex-1 bg-white border border-gray-200 rounded-lg px-2 py-2 text-xs focus:outline-none">
        <button id="btnApplyHoliday" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-xs font-medium hover:bg-blue-700">Aplicar</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">Usa formato HH:mm–HH:mm separado por coma para múltiples franjas.</p>
    </div>
  </div>
</section>
<script>
  
</script>

<script>
  // Datos del servidor (inyecta horarios como JSON para uso en JS)
  window.__HORARIOS__ = <%- JSON.stringify(horarios || []) %>;

  // Helpers para formatear
  function fmt(h, m) { return h ? h.slice(0,5) : null; } // "HH:MM:SS" -> "HH:MM"
  function bloque(d) {
    // Devuelve string tipo "09:00–18:00 (comida 14:00–15:00)" o "Descanso"
    const e = d.entrada, s = d.salida, ci = d.comida_ini, cf = d.comida_fin;
    if (!e && !s && !ci && !cf) return 'Descanso';
    if (e && s) {
      let base = `${fmt(e)}–${fmt(s)}`;
      if (ci && cf) base += `  (comida ${fmt(ci)}–${fmt(cf)})`;
      return base;
    }
    // Si hay algo incompleto, lo mostramos parcial
    return [fmt(e), fmt(s)].filter(Boolean).join('–') || '—';
  }
  function mapDia(row, pref) {
    return {
      entrada: row[`${pref}_entrada`],
      comida_ini: row[`${pref}_comida_ini`],
      comida_fin: row[`${pref}_comida_fin`],
      salida: row[`${pref}_salida`]
    };
  }
  const etiquetas = { lun:'Lunes', mar:'Martes', mie:'Miércoles', jue:'Jueves', vie:'Viernes', sab:'Sábado', dom:'Domingo' };

  // UI refs
  const sel = document.getElementById('scheduleSelect');
  const prev = document.getElementById('schedulePreview');
  const prevName = document.getElementById('previewName');
  const prevBadge = document.getElementById('previewBadge');
  const prevBody = document.getElementById('previewBody');
  const btnEdit = document.getElementById('btnEditSchedule');
  const btnDel = document.getElementById('btnDelSchedule');

  // Editor inputs
  const editorIds = { lun:'mon', mar:'tue', mie:'wed', jue:'thu', vie:'fri', sab:'sat', dom:'sun' };

  function fillPreview(h) {
    prevName.textContent = h.nombre;
    prevBadge.textContent = h.activo ? 'Activo' : 'Inactivo';
    prevBadge.className = 'ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium border ' +
      (h.activo ? 'border-green-200 text-green-700 bg-green-50' : 'border-gray-200 text-gray-600 bg-gray-50');

    prevBody.innerHTML = '';
    ['lun','mar','mie','jue','vie','sab','dom'].forEach(p => {
      const d = mapDia(h, p);
      const item = document.createElement('div');
      item.className = 'flex items-center justify-between bg-white border border-gray-200 rounded-lg p-2';
      item.innerHTML = `<span>${etiquetas[p]}</span><span class="font-medium">${bloque(d)}</span>`;
      prevBody.appendChild(item);
    });
    prev.classList.remove('hidden');
  }

  function fillEditor(h) {
    // Llena los inputs "09:00-18:00" por día (o "—" si descanso)
    ['lun','mar','mie','jue','vie','sab','dom'].forEach(p => {
      const inp = document.getElementById(editorIds[p]);
      const d = mapDia(h, p);
      if (!d.entrada && !d.salida) {
        inp.value = '—';
        return;
      }
      const base = [fmt(d.entrada), fmt(d.salida)].filter(Boolean).join('-');
      const comida = (d.comida_ini && d.comida_fin) ? `; ${fmt(d.comida_ini)}-${fmt(d.comida_fin)}` : '';
      inp.value = base + comida;
    });
  }

  sel?.addEventListener('change', () => {
    const id = Number(sel.value);
    const h = (window.__HORARIOS__ || []).find(x => x.id_horario === id);
    const enabled = !!h;
    // btnEdit.disabled = !enabled;
    // btnDel.disabled = !enabled;
    if (btnEdit) btnEdit.disabled = !enabled;  // ← protege si no existe
    if (btnDel)  btnDel.disabled  = !enabled;

    if (h) {
      fillPreview(h);
      fillEditor(h);
    } else {
      prev.classList.add('hidden');
    }
  });
  

  btnDel?.addEventListener('click', () => {
  const id = Number(sel?.value);
  if (!id) return;

  if (!confirm('¿Seguro que deseas eliminar este horario? Esta acción no se puede deshacer.')) {
    return;
  }

  fetch(`/horarios-semanales/${id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        alert(data.msg || 'No se pudo eliminar el horario');
        return;
      }
      alert('Horario eliminado con éxito');
      location.reload();
    })
    .catch(err => {
      console.error('Error en fetch eliminar:', err);
      alert('Error de red al eliminar');
    });
});


  // Si quieres seleccionar el primero automáticamente:
  // if (window.__HORARIOS__ && window.__HORARIOS__.length) {
  //   sel.value = String(window.__HORARIOS__[0].id_horario);
  //   sel.dispatchEvent(new Event('change'));
  // }
</script>


  <!-- Políticas de acceso -->
  <!-- <section class="bg-white rounded-2xl border border-gray-200 p-4">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Políticas de acceso</h2>
    <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
      <label class="md:col-span-4">
        <span class="text-sm text-gray-700">Política</span>
        <select id="policySelect" class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
          !-- Llenar con GET /api/v1/developer/access_policies --
          <option value="">(Selecciona)</option>
        </select>
      </label>
      <label class="md:col-span-4">
        <span class="text-sm text-gray-700">Horario asignado</span>
        <select id="policySchedule" class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
          !-- schedule_id de la política --
          <option value="">(Ninguno)</option>
        </select>
      </label>
      <label class="md:col-span-4">
        <span class="text-sm text-gray-700">Recursos (puertas / grupos)</span>
        <input id="policyResources" placeholder='["door-id","door-group-id"]' class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm">
      </label>
    </div>
    <div class="mt-3 flex items-center gap-2">
      <button id="btnNewPolicy" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Nueva</button>
      <button id="btnSavePolicy" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">Guardar</button>
      <button id="btnDelPolicy" class="px-3 py-2 rounded-lg border border-red-200 bg-white text-sm text-red-700 hover:bg-red-50">Eliminar</button>
    </div>
  </section> -->

  <!-- Credenciales: PIN & NFC -->
<script>
  window.USUARIOS = <%- JSON.stringify(usuarios || []) %>;
</script>

<!-- Credenciales: PIN & NFC -->
<section class="bg-white rounded-2xl border border-gray-200 p-4">
  <h2 class="text-lg font-semibold text-gray-900 mb-3">Credenciales</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- PIN -->
    <div class="bg-gray-50 border border-gray-100 rounded-xl p-3">
      <div class="text-sm font-medium text-gray-900 mb-2">PIN</div>

      <!-- Selector de usuario (antes "User ID") -->
      <div class="mb-2">
        <div class="text-xs text-gray-600 mb-1">Usuario</div>
        <div class="relative">
          <input id="pinUserSearch" placeholder="Buscar por nombre o puesto..."
                 class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <!-- dropdown -->
          <div id="pinUserDropdown"
               class="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-xl shadow-sm hidden max-h-56 overflow-auto"></div>
        </div>
        <input type="hidden" id="pinSelectedUserId">
      </div>

      <!-- Búsqueda por PIN en tiempo real -->
      <div class="relative">
        <div class="flex items-center gap-2">
          <input id="pinSearch"
                 type="text"
                 inputmode="numeric"
                 placeholder="Escribe un PIN (p. ej. 3841)"
                 class="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                 aria-autocomplete="list" aria-expanded="false" aria-controls="pinSuggestions">
          <button id="btnGenPin"
                  class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">
            Generar
          </button>
          <button id="btnClearPin"
                  class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">
            Limpiar
          </button>
        </div>

        <!-- Sugerencias por PIN -->
        <div id="pinSuggestions"
             class="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden hidden"></div>
      </div>

      <!-- Resultado exacto por PIN -->
      <div id="pinExactResult" class="mt-3">
        <p id="pinResult" class="text-xs text-gray-500">Escribe un PIN para buscar…</p>
      </div>
    </div>

    <!-- NFC -->
    <div class="bg-gray-50 border border-gray-100 rounded-xl p-3">
      <div class="text-sm font-medium text-gray-900 mb-2">NFC</div>

      <!-- Selector de usuario (antes "User ID") -->
      <div class="mb-2">
        <div class="text-xs text-gray-600 mb-1">Usuario</div>
        <div class="relative">
          <input id="nfcUserSearch" placeholder="Buscar por nombre o puesto..."
                 class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <div id="nfcUserDropdown"
               class="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-xl shadow-sm hidden max-h-56 overflow-auto"></div>
        </div>
        <input type="hidden" id="nfcSelectedUserId">
      </div>

      <div class="grid grid-cols-2 gap-2">
        <input id="nfcCardId" placeholder="Card ID (UID)" class="bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm">
      </div>
      <div class="mt-2 flex items-center gap-2">
        <button id="btnEnrollNfc"
                class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">
          Iniciar enrolamiento
        </button>
        <button id="btnCancelNfc"
                class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">
          Cancelar
        </button>
      </div>
      <p id="nfcResult" class="text-xs text-gray-500 mt-2">—</p>
    </div>
  </div>
</section>

<script>
  // ========= Helpers =========
  const $ = (q) => document.querySelector(q);
  const createUserItem = (u) => `
    <button type="button" data-id="${u.id_usuario}"
      class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 flex items-center justify-between">
      <span class="truncate">${u.nombre_completo}</span>
      <span class="text-xs text-gray-500 ml-2">${u.puesto || ''}</span>
    </button>`;

  function mountUserSearch(inputEl, dropdownEl, hiddenIdEl) {
    const users = Array.isArray(window.USUARIOS) ? window.USUARIOS : [];

    function renderList(list) {
      if (!list.length) {
        dropdownEl.innerHTML = `<div class="px-3 py-2 text-sm text-gray-500">Sin resultados</div>`;
      } else {
        dropdownEl.innerHTML = list.slice(0, 50).map(createUserItem).join('');
      }
      dropdownEl.classList.remove('hidden');
    }

    inputEl.addEventListener('input', () => {
      const q = inputEl.value.trim().toLowerCase();
      if (!q) {
        dropdownEl.classList.add('hidden');
        hiddenIdEl.value = '';
        return;
      }
      const res = users.filter(u =>
        (u.nombre_completo || '').toLowerCase().includes(q) ||
        (u.puesto || '').toLowerCase().includes(q)
      );
      renderList(res);
    });

    dropdownEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const u = users.find(x => String(x.id_usuario) === String(id));
      if (u) {
        inputEl.value = `${u.nombre_completo}${u.puesto ? ' • ' + u.puesto : ''}`;
        hiddenIdEl.value = u.id_usuario;
      }
      dropdownEl.classList.add('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!dropdownEl.contains(e.target) && e.target !== inputEl) {
        dropdownEl.classList.add('hidden');
      }
    });
  }

  // ========= Monta selectores de usuarios (PIN y NFC) =========
  mountUserSearch($('#pinUserSearch'), $('#pinUserDropdown'), $('#pinSelectedUserId'));
  mountUserSearch($('#nfcUserSearch'), $('#nfcUserDropdown'), $('#nfcSelectedUserId'));

  // ========= Búsqueda por PIN (UI, mock) =========
  // Nota: Aquí no conozco tu fuente real de "pin" por usuario. 
  // Si más adelante me pasas la tabla/columna, lo adaptamos a fetch('/api/usuarios?pin=...').
  const pinInput = $('#pinSearch');
  const pinSuggestions = $('#pinSuggestions');
  const pinResultBox = $('#pinExactResult');
  const pinResultText = $('#pinResult');
  const btnGenPin = $('#btnGenPin');
  const btnClearPin = $('#btnClearPin');

  // Si tienes los PINs en tu tabla, podrías rellenar este array desde el backend; por ahora es UI vacía.
  const MOCK_PINS = []; // [{ pin:'3841', id_usuario: 123, nombre:'...', puesto:'...' }]

  let debounceTimer = null;
  const debounce = (fn, d=120) => { clearTimeout(debounceTimer); debounceTimer = setTimeout(fn, d); };

  function renderExact(user) {
    if (!user) {
      pinResultBox.innerHTML = `
        <div class="rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-amber-800 text-sm">
          No hay coincidencia exacta para ese PIN.
        </div>`;
      return;
    }
    pinResultBox.innerHTML = `
      <div class="flex items-center gap-3 rounded-xl border border-gray-200 bg-white p-3">
        <img src="https://i.pravatar.cc/80?u=${user.id_usuario}" class="w-12 h-12 rounded-lg border border-gray-200" alt="">
        <div class="flex-1">
          <div class="text-sm font-medium text-gray-900">${user.nombre}</div>
          <div class="text-xs text-gray-500">${user.puesto || ''}</div>
          <div class="mt-1 text-xs text-gray-400">User ID: <span class="text-gray-700">${user.id_usuario}</span> • PIN:
            <span class="inline-flex items-center px-1.5 py-0.5 rounded-md border border-blue-200 bg-blue-50 text-blue-700 font-medium">
              ${user.pin}
            </span>
          </div>
        </div>
        <span class="px-2 py-1 text-xs rounded-lg bg-green-50 text-green-700 border border-green-200">Coincidencia exacta</span>
      </div>`;
  }

  function renderSuggestions(list, query) {
    if (!query) {
      pinSuggestions.classList.add('hidden');
      pinInput.setAttribute('aria-expanded', 'false');
      return;
    }
    const items = list.slice(0, 6).map(u => `
      <button type="button" data-pin="${u.pin}"
        class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 flex items-center justify-between">
        <span>${u.pin}</span>
        <span class="text-xs text-gray-500 truncate max-w-[60%]">${u.nombre}${u.puesto ? ' • ' + u.puesto : ''}</span>
      </button>`).join('');
    pinSuggestions.innerHTML = items || `<div class="px-3 py-2 text-sm text-gray-500">Sin coincidencias</div>`;
    pinSuggestions.classList.remove('hidden');
    pinInput.setAttribute('aria-expanded', 'true');
  }

  function handlePinSearch() {
    const q = pinInput.value.trim();
    pinResultText.textContent = q ? `Buscando “${q}”…` : 'Escribe un PIN para buscar…';

    const partial = q ? MOCK_PINS.filter(u => u.pin.includes(q)) : [];
    renderSuggestions(partial, q);

    const exact = q ? MOCK_PINS.find(u => u.pin === q) : null;
    renderExact(exact);
  }

  pinInput.addEventListener('input', () => debounce(handlePinSearch, 120));
  pinSuggestions.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-pin]');
    if (!btn) return;
    const value = btn.getAttribute('data-pin');
    pinInput.value = value;
    handlePinSearch();
    pinSuggestions.classList.add('hidden');
    pinInput.setAttribute('aria-expanded', 'false');
  });
  document.addEventListener('click', (e) => {
    if (!pinSuggestions.contains(e.target) && e.target !== pinInput) {
      pinSuggestions.classList.add('hidden');
      pinInput.setAttribute('aria-expanded', 'false');
    }
  });
  btnGenPin.addEventListener('click', () => {
    const rnd = String(Math.floor(1000 + Math.random() * 9000));
    pinInput.value = rnd;
    handlePinSearch();
  });
  btnClearPin.addEventListener('click', () => {
    pinInput.value = '';
    pinSuggestions.classList.add('hidden');
    pinInput.setAttribute('aria-expanded', 'false');
    pinResultBox.innerHTML = '';
    pinResultText.textContent = 'Escribe un PIN para buscar…';
    pinInput.focus();
  });
  handlePinSearch();
</script>
<script>
  // === Enrolamiento NFC: POST /api/nfc/enroll ===
  const nfcUserIdInput = document.querySelector('#nfcSelectedUserId');
  const nfcCardIdInput = document.querySelector('#nfcCardId');
  const nfcResult      = document.querySelector('#nfcResult');
  const btnEnrollNfc   = document.querySelector('#btnEnrollNfc');
  const btnCancelNfc   = document.querySelector('#btnCancelNfc');
  const CSRF_TOKEN     = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || null;

  function setNfcBusy(b){ btnEnrollNfc.disabled=b; btnCancelNfc.disabled=b; btnEnrollNfc.textContent=b?'Enrolando…':'Iniciar enrolamiento'; }
  function msg(text,kind='info'){
    const styles={info:'bg-blue-50 border-blue-200 text-blue-800',ok:'bg-green-50 border-green-200 text-green-700',warn:'bg-amber-50 border-amber-200 text-amber-800',error:'bg-rose-50 border-rose-200 text-rose-700'};
    nfcResult.className=`text-sm mt-2 px-3 py-2 rounded-lg border ${styles[kind]||''}`; nfcResult.textContent=text;
  }

  async function enrollNfc({forceReplace=false}={}) {
    const id_usuario = parseInt(nfcUserIdInput.value,10);
    const numero_tarjeta = (nfcCardIdInput.value||'').trim();
    if(!id_usuario){ msg('Selecciona un usuario.', 'warn'); return; }
    if(!numero_tarjeta){ msg('Escribe el Card ID (UID).', 'warn'); return; }
    if(numero_tarjeta.length>50){ msg('El Card ID excede 50 caracteres.', 'warn'); return; }

    setNfcBusy(true); msg('Procesando…','info');
    try{
      const resp = await fetch('/api/nfc/enroll', {
        method:'POST',
        headers: {'Content-Type':'application/json', ...(CSRF_TOKEN?{'x-csrf-token':CSRF_TOKEN}:{})},
        credentials:'same-origin',
        body: JSON.stringify({ id_usuario, numero_tarjeta, forceReplace })
      });
      const data = await resp.json().catch(()=>({}));

      if(resp.ok){ msg(data?.msg||'Tarjeta enrolada.', 'ok'); return; }
      if(resp.status===409){
        msg(data?.msg||'Conflicto de asignación.', 'warn');
        if(confirm((data?.msg||'Conflicto.')+'\n\n¿Forzar reemplazo?')){
          await enrollNfc({forceReplace:true});
        }
        return;
      }
      msg(data?.msg||'No se pudo completar el enrolamiento.', 'error');
    }catch(e){
      console.error(e); msg('Error de red/servidor.', 'error');
    }finally{ setNfcBusy(false); }
  }

  btnEnrollNfc.addEventListener('click', ()=>enrollNfc());
  btnCancelNfc.addEventListener('click', ()=>{
    nfcCardIdInput.value=''; msg('—','info');
  });
</script>



  <!-- Grupos de puertas -->
  <!-- <section class="bg-white rounded-2xl border border-gray-200 p-4">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Grupos de puertas</h2>
    <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
      <label class="md:col-span-5">
        <span class="text-sm text-gray-700">Grupo</span>
        <select id="doorGroupSelect" class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
          !-- GET /api/v1/developer/door_groups --
          <option value="">(Selecciona)</option>
        </select>
      </label>
      <label class="md:col-span-5">
        <span class="text-sm text-gray-700">Puertas incluidas (IDs)</span>
        <input id="doorGroupResources" placeholder='["door-id-1","door-id-2"]' class="mt-1 w-full rounded-lg border border-gray-200 px-3 py-2 text-sm">
      </label>
      <div class="md:col-span-2 flex items-end gap-2">
        <button id="btnNewGroup" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Nuevo</button>
        <button id="btnSaveGroup" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">Guardar</button>
        <button id="btnDelGroup" class="px-3 py-2 rounded-lg border border-red-200 bg-white text-sm text-red-700 hover:bg-red-50">Eliminar</button>
      </div>
    </div>
  </section> -->

<!-- ================ Modal: Nuevo horario semanal (con scroll) ================= -->
<div id="modalHorarioSemanal" class="fixed inset-0 z-[60] hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/40" data-ws-overlay></div>

  <!-- Overlay scrollable -->
  <div class="relative h-full w-full overflow-y-auto">
    <div class="mx-auto my-8 w-full max-w-5xl">
      <!-- Card -->
      <div class="flex max-h-[85vh] flex-col rounded-2xl bg-white shadow-2xl border border-gray-200">
        <!-- Header fijo -->
        <div class="sticky top-0 z-10 bg-white p-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Nuevo horario semanal</h3>
            <button type="button" class="p-2 rounded-lg hover:bg-gray-100" data-ws-close aria-label="Cerrar">✕</button>
          </div>
        </div>

        <!-- Body scrollable -->
        <div class="p-4 overflow-y-auto">
          <form id="formHorarioSemanal" class="space-y-4">
            <!-- Nombre + Activo + Utilidad -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
              <label class="md:col-span-6 block">
                <span class="text-sm text-gray-700">Nombre del horario</span>
                <input type="text" name="nombre" id="ws_nombre" required maxlength="60"
                        class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600"
                        placeholder="Ej. Turno Matutino RH">
              </label>

              <div class="md:col-span-3 flex items-end">
                <label class="inline-flex items-center gap-2 select-none">
                  <input type="checkbox" name="activo" id="ws_activo" class="rounded border-gray-300" checked>
                  <span class="text-sm text-gray-700">Activo</span>
                </label>
              </div>

              <div class="md:col-span-3 flex items-end justify-end">
                <button type="button" id="ws_copyMonday"
                        class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">
                  Copiar lunes al resto
                </button>
              </div>
            </div>

            <!-- Días de la semana -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              <!-- Lunes -->
              <fieldset class="border border-gray-200 rounded-xl p-3">
                <legend class="px-2 text-sm font-medium text-gray-800">Lunes</legend>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Entrada</span>
                    <input type="time" name="lun_entrada" id="lun_entrada"
                           class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (inicio)</span>
                    <input type="time" name="lun_comida_ini" id="lun_comida_ini"
                           class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (fin)</span>
                    <input type="time" name="lun_comida_fin" id="lun_comida_fin"
                           class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Salida</span>
                    <input type="time" name="lun_salida" id="lun_salida"
                           class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                </div>
              </fieldset>

              <!-- Martes -->
              <fieldset class="border border-gray-200 rounded-xl p-3">
                <legend class="px-2 text-sm font-medium text-gray-800">Martes</legend>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Entrada</span>
                    <input type="time" name="mar_entrada" id="mar_entrada" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (inicio)</span>
                    <input type="time" name="mar_comida_ini" id="mar_comida_ini" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (fin)</span>
                    <input type="time" name="mar_comida_fin" id="mar_comida_fin" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Salida</span>
                    <input type="time" name="mar_salida" id="mar_salida" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                </div>
              </fieldset>

              <!-- Miércoles -->
              <fieldset class="border border-gray-200 rounded-xl p-3">
                <legend class="px-2 text-sm font-medium text-gray-800">Miércoles</legend>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Entrada</span>
                    <input type="time" name="mie_entrada" id="mie_entrada" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (inicio)</span>
                    <input type="time" name="mie_comida_ini" id="mie_comida_ini" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (fin)</span>
                    <input type="time" name="mie_comida_fin" id="mie_comida_fin" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Salida</span>
                    <input type="time" name="mie_salida" id="mie_salida" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                </div>
              </fieldset>

              <!-- Jueves -->
              <fieldset class="border border-gray-200 rounded-xl p-3">
                <legend class="px-2 text-sm font-medium text-gray-800">Jueves</legend>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Entrada</span>
                    <input type="time" name="jue_entrada" id="jue_entrada" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (inicio)</span>
                    <input type="time" name="jue_comida_ini" id="jue_comida_ini" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (fin)</span>
                    <input type="time" name="jue_comida_fin" id="jue_comida_fin" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Salida</span>
                    <input type="time" name="jue_salida" id="jue_salida" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                </div>
              </fieldset>

              <!-- Viernes -->
              <fieldset class="border border-gray-200 rounded-xl p-3">
                <legend class="px-2 text-sm font-medium text-gray-800">Viernes</legend>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Entrada</span>
                    <input type="time" name="vie_entrada" id="vie_entrada" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (inicio)</span>
                    <input type="time" name="vie_comida_ini" id="vie_comida_ini" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (fin)</span>
                    <input type="time" name="vie_comida_fin" id="vie_comida_fin" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Salida</span>
                    <input type="time" name="vie_salida" id="vie_salida" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                </div>
              </fieldset>

              <!-- Sábado -->
              <fieldset class="border border-gray-200 rounded-xl p-3">
                <legend class="px-2 text-sm font-medium text-gray-800">Sábado</legend>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Entrada</span>
                    <input type="time" name="sab_entrada" id="sab_entrada" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (inicio)</span>
                    <input type="time" name="sab_comida_ini" id="sab_comida_ini" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (fin)</span>
                    <input type="time" name="sab_comida_fin" id="sab_comida_fin" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Salida</span>
                    <input type="time" name="sab_salida" id="sab_salida" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                </div>
              </fieldset>

              <!-- Domingo -->
              <fieldset class="border border-gray-200 rounded-xl p-3">
                <legend class="px-2 text-sm font-medium text-gray-800">Domingo</legend>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Entrada</span>
                    <input type="time" name="dom_entrada" id="dom_entrada" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (inicio)</span>
                    <input type="time" name="dom_comida_ini" id="dom_comida_ini" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block">
                    <span class="text-xs text-gray-600">Comida (fin)</span>
                    <input type="time" name="dom_comida_fin" id="dom_comida_fin" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                  <label class="block col-span-2">
                    <span class="text-xs text-gray-600">Salida</span>
                    <input type="time" name="dom_salida" id="dom_salida" class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600">
                  </label>
                </div>
              </fieldset>
            </div>

            <p class="text-xs text-gray-500">* Deja vacío un día para marcarlo como descanso. Si capturas comida, llena inicio y fin.</p>
          </form>
        </div>

        <!-- Footer fijo -->
        <div class="sticky bottom-0 z-10 bg-white p-4 border-t border-gray-200 flex items-center justify-end gap-2">
          <button type="button" class="px-3 py-2 rounded-lg border border-gray-200 text-sm text-gray-700 hover:bg-gray-50" data-ws-close>Cancelar</button>
          <button type="submit" form="formHorarioSemanal" id="ws_submit" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700 disabled:opacity-50">Guardar</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ================== /Modal ================== -->


  
<script>
  function openModal() {
  document.getElementById('modalHorarioSemanal').classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
}
function closeModal() {
  document.getElementById('modalHorarioSemanal').classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
}

  (function () {
    const openBtn = document.getElementById('btnNewSchedule'); // tu botón existente
    const modal = document.getElementById('modalHorarioSemanal');
    const overlay = modal?.querySelector('[data-ws-overlay]');
    const closeBtns = modal?.querySelectorAll('[data-ws-close]');
    const form = document.getElementById('formHorarioSemanal');
    const submitBtn = document.getElementById('ws_submit');
    const copyMondayBtn = document.getElementById('ws_copyMonday');

    function openModal() {
      modal.classList.remove('hidden');
      setTimeout(() => document.getElementById('ws_nombre')?.focus(), 50);
      document.addEventListener('keydown', onEsc);
    }
    function closeModal() {
      modal.classList.add('hidden');
      document.removeEventListener('keydown', onEsc);
      form.reset();
    }
    function onEsc(e) { if (e.key === 'Escape') closeModal(); }

    openBtn?.addEventListener('click', openModal);
    overlay?.addEventListener('click', closeModal);
    closeBtns?.forEach(b => b.addEventListener('click', closeModal));

    // Utilidad: copiar lunes al resto
    copyMondayBtn?.addEventListener('click', () => {
      const fields = ['entrada', 'comida_ini', 'comida_fin', 'salida'];
      const lunes = fields.map(f => document.getElementById('lun_' + f)?.value || '');
      const dias = ['mar', 'mie', 'jue', 'vie', 'sab', 'dom'];
      dias.forEach(d => fields.forEach((f, i) => {
        const el = document.getElementById(d + '_' + f);
        if (el) el.value = lunes[i];
      }));
    });

    // Helpers
    function t2m(t) {
      if (!t) return null;
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    }
    function validarBloque(entrada, cIni, cFin, salida, etiquetaDia) {
      const e = t2m(entrada), ci = t2m(cIni), cf = t2m(cFin), s = t2m(salida);
      // Si no hay nada, el día se considera descanso y es válido
      if (entrada === '' && cIni === '' && cFin === '' && salida === '') return true;

      // Reglas mínimas si hay horas
      if (!entrada || !salida) {
        alert(`En ${etiquetaDia}: si capturas horario, debes poner entrada y salida.`);
        return false;
      }
      if (s <= e) {
        alert(`En ${etiquetaDia}: la salida debe ser posterior a la entrada.`);
        return false;
      }
      // Si hay comida, debe estar completa y dentro del turno
      const algunoComida = (cIni !== '' || cFin !== '');
      if (algunoComida && (!cIni || !cFin)) {
        alert(`En ${etiquetaDia}: si capturas comida, debes poner inicio y fin.`);
        return false;
      }
      if (ci != null && (ci <= e || ci >= s)) {
        alert(`En ${etiquetaDia}: la entrada a comer debe estar dentro del turno.`);
        return false;
      }
      if (cf != null && (cf <= e || cf >= s || (ci != null && cf <= ci))) {
        alert(`En ${etiquetaDia}: la salida de comer debe ser después del inicio y dentro del turno.`);
        return false;
      }
      return true;
    }

    form?.addEventListener('input', () => {
      submitBtn.disabled = !form.checkValidity();
    });

    form?.addEventListener('submit', (e) => {
      e.preventDefault();

      // Validar por día (solo si hay datos)
      const dias = [
        { p: 'lun', n: 'Lunes' },
        { p: 'mar', n: 'Martes' },
        { p: 'mie', n: 'Miércoles' },
        { p: 'jue', n: 'Jueves' },
        { p: 'vie', n: 'Viernes' },
        { p: 'sab', n: 'Sábado' },
        { p: 'dom', n: 'Domingo' },
      ];

      for (const d of dias) {
        const eV = form[`${d.p}_entrada`].value;
        const ciV = form[`${d.p}_comida_ini`].value;
        const cfV = form[`${d.p}_comida_fin`].value;
        const sV = form[`${d.p}_salida`].value;
        if (!validarBloque(eV, ciV, cfV, sV, d.n)) return;
      }

      // Construir payload con null para vacíos (match columnas MySQL)
      const payload = {
        nombre: form.nombre.value.trim(),
        activo: form.activo.checked ? 1 : 0,

        lun_entrada: form.lun_entrada.value || null,
        lun_comida_ini: form.lun_comida_ini.value || null,
        lun_comida_fin: form.lun_comida_fin.value || null,
        lun_salida: form.lun_salida.value || null,

        mar_entrada: form.mar_entrada.value || null,
        mar_comida_ini: form.mar_comida_ini.value || null,
        mar_comida_fin: form.mar_comida_fin.value || null,
        mar_salida: form.mar_salida.value || null,

        mie_entrada: form.mie_entrada.value || null,
        mie_comida_ini: form.mie_comida_ini.value || null,
        mie_comida_fin: form.mie_comida_fin.value || null,
        mie_salida: form.mie_salida.value || null,

        jue_entrada: form.jue_entrada.value || null,
        jue_comida_ini: form.jue_comida_ini.value || null,
        jue_comida_fin: form.jue_comida_fin.value || null,
        jue_salida: form.jue_salida.value || null,

        vie_entrada: form.vie_entrada.value || null,
        vie_comida_ini: form.vie_comida_ini.value || null,
        vie_comida_fin: form.vie_comida_fin.value || null,
        vie_salida: form.vie_salida.value || null,

        sab_entrada: form.sab_entrada.value || null,
        sab_comida_ini: form.sab_comida_ini.value || null,
        sab_comida_fin: form.sab_comida_fin.value || null,
        sab_salida: form.sab_salida.value || null,

        dom_entrada: form.dom_entrada.value || null,
        dom_comida_ini: form.dom_comida_ini.value || null,
        dom_comida_fin: form.dom_comida_fin.value || null,
        dom_salida: form.dom_salida.value || null,
      };

      console.log('Nuevo horario semanal (payload listo):', payload);

      // Frontend (dentro del submit del modal)
      fetch('/horarios-semanales/new', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(data => {
        if (!data.ok) {
          alert(data.msg || 'No se pudo guardar.');
          return;
        }
        // Éxito: data.id_horario
        // Aquí recargas, cierras modal, refrescas tabla, etc.
        // location.reload();
      })
      .catch(() => alert('Error de red al guardar.'));


      closeModal();
    });
  })();
</script>


  <!-- Script de integración (solo frontend; reemplaza host/token) -->
  <script>
    const HOST = 'https://TU_CONSOLA';           // p.ej. https://udm-ip o https://xyz.ui.com
    const TOKEN = 'Bearer TU_TOKEN_API';         // Authorization: Bearer <token>

    // Helpers
    const $ = s => document.querySelector(s);
    const headersJSON = { 'Authorization': TOKEN, 'accept':'application/json', 'content-type':'application/json' };

    // ===== Puertas =====
    async function fetchDoors() {
      // const r = await fetch(\`\${HOST}/api/v1/developer/doors\`, { headers: headersJSON });
      // const { data } = await r.json();
      // Llena #doorSelect con data[]
    }
    async function fetchDoorState(doorId) {
      // GET detalle puerta (relé/posición)
      // const r = await fetch(\`\${HOST}/api/v1/developer/doors/\${doorId}\`, { headers: headersJSON });
      // const { data } = await r.json();
      // $('#relayStatus').textContent = data.door_lock_relay_status || '—';
      // $('#dps').textContent = data.door_position_status || '—';
    }
    async function fetchLockRule(doorId) {
      // GET /doors/:id/lock_rule
      // const r = await fetch(\`\${HOST}/api/v1/developer/doors/\${doorId}/lock_rule\`, { headers: headersJSON });
      // const { data } = await r.json();
      // $('#lockRule').textContent = data?.type || '—';
      // $('#lockEnds').textContent = data?.ended_time ? new Date(data.ended_time*1000).toLocaleString() : '—';
    }
    async function putUnlock(doorId) {
      // PUT /doors/:id/unlock
      // await fetch(\`\${HOST}/api/v1/developer/doors/\${doorId}/unlock\`, { method:'PUT', headers: headersJSON });
    }
    async function putLockRule(doorId, type, seconds=null) {
      // types: keep_lock | keep_unlock | lock_early | reset | custom(+ended_time)
      // body: { "type":"custom", "ended_time": 1708673342 } // epoch sec
      // await fetch(\`\${HOST}/api/v1/developer/doors/\${doorId}/lock_rule\`, {
      //   method:'PUT', headers: headersJSON,
      //   body: JSON.stringify(type==='custom' ? { type, ended_time: seconds } : { type })
      // });
    }
    async function putEmergency({ lockdown=false, evacuation=false }) {
      // PUT /doors/settings/emergency { lockdown: true/false, evacuation: true/false }
      // await fetch(\`\${HOST}/api/v1/developer/doors/settings/emergency\`, { method:'PUT', headers: headersJSON, body: JSON.stringify({ lockdown, evacuation }) });
      // Luego GET para leer estado
      // const r = await fetch(\`\${HOST}/api/v1/developer/doors/settings/emergency\`, { headers: headersJSON });
      // const { data } = await r.json();
      // $('#emergStatus').textContent = \`lockdown=\${data.lockdown} / evacuation=\${data.evacuation}\`;
    }

    // ===== Horarios & Festivos =====
    async function fetchSchedules() {
      // GET /access_policies/schedules
      // const r = await fetch(\`\${HOST}/api/v1/developer/access_policies/schedules\`, { headers: headersJSON });
      // const { data } = await r.json();
      // Llena #scheduleSelect
    }
    async function createSchedule(payload) {
      // POST /access_policies/schedules { name, week_schedule:{monday:[{start_time,end_time}],...}, holiday_group_id, holiday_schedule:[...] }
      // return fetch(\`\${HOST}/api/v1/developer/access_policies/schedules\`, { method:'POST', headers: headersJSON, body: JSON.stringify(payload) });
    }
    async function updateSchedule(id, payload) {
      // PUT /access_policies/schedules/:id
    }
    async function deleteSchedule(id) {
      // DELETE /access_policies/schedules/:id
    }
    async function fetchHolidayGroups() {
      // GET /access_policies/holiday_groups
    }

    // ===== Políticas =====
    async function fetchPolicies() {
      // GET /access_policies
    }
    async function createPolicy({ name, resources, schedule_id }) {
      // POST /access_policies  { name, resource:[{id,type}], schedule_id }
    }
    async function updatePolicy(id, { name, resources, schedule_id }) {
      // PUT /access_policies/:id
    }
    async function deletePolicy(id) {
      // DELETE /access_policies/:id
    }

    // ===== Credenciales =====
    async function generatePin(userId) {
      // POST /api/v1/developer/credentials/pin  (ver sección Credential)
      // const r = await fetch(\`\${HOST}/api/v1/developer/credentials/pin\`, { method:'POST', headers: headersJSON, body: JSON.stringify({ user_id:userId }) });
      // const { data } = await r.json(); $('#pinResult').textContent = \`PIN: \${data.pin}\`;
    }
    async function enrollNfc(userId, cardId) {
      // Flujo NFC (ver Credential + User assign):
      // 1) Iniciar sesión de enrolamiento (endpoint de Credential/NFC enroll)
      // 2) Consultar estado hasta ver la card UID
      // 3) Asignar tarjeta al usuario: PUT /api/v1/developer/users/:user_id/nfc_cards  (sección 3.7 Assign NFC Card to User)
      // 4) Cerrar sesión de enrolamiento
    }

    // ===== Door Groups =====
    async function fetchDoorGroups() {
      // GET /api/v1/developer/door_groups  (o /door_groups/topology para armar árbol)
    }
    async function createDoorGroup({ group_name, resources }) {
      // POST /door_groups { group_name, resources: ["door-id", ...] }
    }
    async function updateDoorGroup(id, { group_name, resources }) {
      // PUT /door_groups/:id
    }
    async function deleteDoorGroup(id) {
      // DELETE /door_groups/:id
    }

    // ====== Eventos UI (demo) ======
    $('#btnUnlock').addEventListener('click', ()=> putUnlock($('#doorSelect').value));
    $('#btnRuleLock').addEventListener('click', ()=> putLockRule($('#doorSelect').value, 'keep_lock'));
    $('#btnRuleUnlock').addEventListener('click', ()=> putLockRule($('#doorSelect').value, 'keep_unlock'));
    $('#btnRuleCustom').addEventListener('click', ()=> {
      const mins = prompt('Minutos de desbloqueo temporal:', '10'); 
      if (!mins) return;
      const ends = Math.floor(Date.now()/1000) + (parseInt(mins,10)*60);
      putLockRule($('#doorSelect').value, 'custom', ends);
    });
    $('#btnLockdown').addEventListener('click', ()=> putEmergency({ lockdown:true, evacuation:false }));
    $('#btnEvac').addEventListener('click', ()=> putEmergency({ lockdown:false, evacuation:true }));
    $('#btnEmergReset').addEventListener('click', ()=> putEmergency({ lockdown:false, evacuation:false }));

    $('#btnGenPin').addEventListener('click', ()=> generatePin($('#pinUserId').value));
    $('#btnEnrollNfc').addEventListener('click', ()=> enrollNfc($('#nfcUserId').value, $('#nfcCardId').value));

    // Carga inicial (deja comentado hasta conectar)
    // fetchDoors().then(()=> {
    //   const id = $('#doorSelect').value;
    //   fetchDoorState(id); fetchLockRule(id);
    // });
    // fetchSchedules(); fetchHolidayGroups(); fetchPolicies(); fetchDoorGroups();
  </script>
<%- include ('Plantilla/Final') %>